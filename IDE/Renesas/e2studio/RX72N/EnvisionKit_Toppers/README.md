## Renesas RX72N EnvisionKit with TOPPERS OS 

本デモはルネサス「RX72N EnvisionKit 」に「Toopers OS」を適用し「WolfSSL」の動作を確認します

# 本デモについては以下が必要です 

1.Renesas e² studio Version: 2022-07 (22.7.0)以降   
2.Toopers OS 1.91.1 Renesas RX72N適用バージョン   
3.WolfSSL Release 5.0.0 以降 (gitレポジトリーより入手)  

# 以下に環境構築手順を示します
 # 1.ライブラリー作成
  本デモに必要なToppersライブラリー、wolfSSLライブラリーを作成します  
 1-1.メニューの[ファイル]→[インポート(I)...]→[既存プロジェクトをワークスペースへ]→[次へ]を選択  
 1-2.[プロジェクトをインポート]ダイアログの[ルートディレクトリーの選択(T)]の[参照(R)]を押下
 1-3.git レポジトリwolfssl/IDE/Renesas/e2studio/RX72N/EnvisionKit_Toppersの[wolflib]を選択[フォルダーの選択]を押下      
 1-4. [プロジェクト・エクスプローラー]でプロジェクトを選択後右クリックを行い、コンテキストメニュー[プロパティ(R)]を選択→[プロパティ]ダイアログで[C/C++ビルド] をクリックし[設定] を選択
 1-5.設定ダイアログボックス表示後、[ツール設定]タブ[Compiler]設定の[Include]を選択  
 1-6.ダイアログボックス右上[+]を押下しディレクトリを選択ルートディレクトリー[wolfssl-x.x.x]をワークスペース又はファイルシステムより設定  
 1-7.ダイアログボックス右上[+]を押下しディレクトリを選択[wolflib]と同じ階層にある[WolfDemo]をワークスペース又はファイルシステムより設定  
 1-8.プロジェクト・エクスプローラーの作成したプロジェクトをクリック後プルダウンメニューから[プロジェクトのビルド(B)]キーを選択しビルドを行う  
 1-9. [wolflib/Debug]に[libwolflib.a]が生成されます

 1-10.Toppersライブラリーのビルドの為、[https://github.com/nekoman2187/RenesasRX72NEnvisionKitwithToppers]よりgit clone又はダウンロードし解凍します  
 1-11.メニューの[ファイル]→[新規]→[Makefile Project with Existing Code]を選択  
 1-12.[既存のコードをインポート]ダイアログで[プロジェクト名]を入力し[既存のコードの場所]で[7-14]で解凍したディレクトリで[toppers/toppers_app]を指定し、[インデクサー設定に対しますtoolchain]は[GCC for Renesas RX]を選択し[終了]を押下  
 1-13.以下のコマンドを実行  
 ```  
$ pwd
プロジェクトと同じディレクトリ/toppeers_app
$ perl ./toppers_rx/asp/configure -T rx72n_gcc
$ make depend
```  
(コマンド実行ではMsys2等の環境を事前にご用意ください)
(Msys2でgccのツールチェーンのインストールを行う)
(事前にRenesas環境のパス設定を行う.bashrc等)    
(設定例：ルネサスツールチェーンパスを指定)    
 ```  
export PATH=PATH=$PATH:\/C/ProgramData\/GCC\ for\ Renesas\ RX\ 8.3.0.202202-GNURX-ELF/rx-elf/rx-elf/bin
 ``` 
 1-14.プロジェクト・エクスプローラーの作成したプロジェクトをクリック後プルダウンメニューから[プロジェクトのビルド(B)]キーを選択しビルドを行う(ビルドは必ず事前に[7-17]を実施します)  
 1-15. [アーカイブ]に[libasp.a]が生成されます

# 2.e² studioプロジェクト作成 
 2-1.メニューの[ファイル・システムからプロジェクトを開く...]を選択  
 2-2.git レポジトリwolfssl/IDE/Renesas/e2studio/RX72N/EnvisionKit_Toppersの[wolflib]を選択[フォルダーの選択]を押下 (既に本ディレクトリーを含んだwolfsslの環境を展開済みとしてください)  
 2-3.[プロジェクトをインポート]ダイアログの[プロジェクト(P)] チェックボックスを選択後[終了(F)]を押下   
 2-4.[WolfSSLDemo.scfg]をダブルクリックで設定ダイアログが表示→[コンポーネントタブ] を選択     
 2-5.[ソフトウェアコンポーネントダイアログ]ダイアログ右上の[コードの生成]を押下      
 
 2-6.以下を修正  
```
smc_gen\r_t4_driver_rx\src\t4_driver.c  
#include "r_tsip_rx_if.h"  
  ↓  修正  
//#include "r_tsip_rx_if.h"  
```

 # 3.ソースコード追加  
 3-1.上記1-xxで作成したプロジェクトの[プロジェクトエクスプローラー]ダイアログの[src]を選択  
 3-2.メニューの[ファイル]→[インポート(I)...]→[ファイル・システム]を選択[次へ(N)>]を押下  
 3-3.[ファイル・システム]ダイアログ[次のディレクトリーから(Y):]の[参照(R)...]を押下  
 3-4.git レポジトリwolfssl/IDE/Renesas/e2studio/RX72N/EnvisionKit_Toppersの[WolfDemo]を選択    
 3-5.選択ダイアログの[wolfDemo]チェックボックスを選択
 3-6.[ファイル・システム]ダイアログ下の[拡張>>(A)]を選択→[ワークスペースにリンクを作成(K)]のチェックボックスを選択後[終了(F)]を押下   
  
# 4.e² studioプロジェクトインクルードパス設定  
 4-1.プロジェクト・エクスプローラーの作成したプロジェクトをクリック後[Alt＋Enter]キーを押下  
 4-2.[プロパティ:]ダイアログ左側[C/C++ビルド]を選択後、[設定]を選択  
 4-3.設定ダイアログボックス表示後、[ツール設定]タブ[Compiler]設定の[Include]を選択  
 4-4.[include file directories(-I)]ダイアログボックス右上[+]を押下しディレクトリを選択[2]で追加した[WolfDemo]をワークスペースより設定  
 4-5.上記同様ワークスペース又はファイルシステムより[wolfssl-x.x.x]を設定  
     (例:"C:\Users\etc\wolfssl-5.0.0-stable")  
 4-6.[プロジェクトエクスプローラー]をクリックで選択右クリックでコンテキストメニュー[プロジェクトのビルド(R)]を選択(ビルドによりコンフィグレーションからのファイルが生成されます)  


   # 5.e² studio BSP修正
 5-1.上記1～2の終了後生成された[プロジェクトエクスプローラー]をクリックで選択右クリックでコンテキストメニュー[プロジェクトのビルド(R)]を選択  
 (ビルドによりコンフィグレーションからのファイルが生成されます)    

 5-2.生成されたBSPをToppersに適用する為、BSPに以下の変更及び修正を加えます  
 ```  
smc_gen\general\r_cg_hardware_setup.c  
void R_Systeminit(void)  
    R_Interrupt_Create();  が存在した場合
	↓  修正  
   // R_Interrupt_Create();  
smc_gen\r_config
#define BSP_CFG_RTOS_USED               (0)
	↓  修正  
#define BSP_CFG_RTOS_USED               (4)

smc_gen\r_bsp\mcu\all\resetprg.c  
#include    "ri_cmt.h"    /*  Generated by cfg600 */
	↓  修正  
//#include    "ri_cmt.h"    /*  Generated by cfg600 */

#if (BSP_CFG_RTOS_USED == 0) || (BSP_CFG_RTOS_USED == 5)     /* Non-OS or Azure RTOS */
extern void R_BSP_MAIN_FUNCTION(void);
#endif
↓  修正  
#if (BSP_CFG_RTOS_USED == 0) || (BSP_CFG_RTOS_USED == 5) || (BSP_CFG_RTOS_USED == 4)    /* Non-OS or Azure RTOS */
extern void R_BSP_MAIN_FUNCTION(void);
#endif

R_BSP_POR_FUNCTION(R_BSP_STARTUP_FUNCTION)  
#if BSP_CFG_USER_STACK_ENABLE == 1
    INTERNAL_NOT_USED(ustack_area);
#endif
    INTERNAL_NOT_USED(istack_area);
#endif
	↓  修正  
#if BSP_CFG_USER_STACK_ENABLE == 1
   // INTERNAL_NOT_USED(ustack_area);
#endif
  //  INTERNAL_NOT_USED(istack_area);
#endif    
R_BSP_SET_INTB(R_BSP_SECTOP_INTVECTTBL);  
	↓  修正  
// R_BSP_SET_INTB(R_BSP_SECTOP_INTVECTTBL);  

#if BSP_CFG_RTOS_USED == 4  /* Renesas RI600V4 & RI600PX **/  
    R_BSP_MAIN_FUNCTION();★挿入  
    /** Does not change the MCU's user mode to user in Renesas RTOS. **/  
#else /** BSP_CFG_RTOS_USED != 4 **/  
#if BSP_CFG_RUN_IN_USER_MODE == 1  
    /** Change the MCU's user mode from supervisor to user **/  
    #if BSP_CFG_USER_STACK_ENABLE == 1  
        R_BSP_CHG_PMUSR();  
    #else  
        #error "Settings of BSP_CFG_RUN_IN_USER_MODE and BSP_CFG_USER_STACK_ENABLE are inconsistent with each other."  
    #endif  
#endif /** BSP_CFG_RUN_IN_USER_MODE **/  

#elif BSP_CFG_RTOS_USED == 4    /* Renesas RI600V4 & RI600PX */
#if BSP_CFG_RENESAS_RTOS_USED == RENESAS_RI600V4
 	↓  修正
#elif BSP_CFG_RTOS_USED == 6    /* Renesas RI600V4 & RI600PX */
#if BSP_CFG_RENESAS_RTOS_USED == RENESAS_RI600V4

   bsp_interrupt_open();  
 	↓  修正  
   //bsp_interrupt_open();  

#include "kernel_ram.h"     /* generated by cfg600 */
#include "kernel_rom.h"     /* generated by cfg600 */
	↓  修正  
//#include "kernel_ram.h"     /* generated by cfg600 */
//#include "kernel_rom.h"     /* generated by cfg600 */

smc_gen\r_config\r_cmt_rx_config.h  (初回ビルド後に出力)
#if (BSP_CFG_RTOS_USED == 4) && (BSP_CFG_RENESAS_RTOS_USED == 0) /* RI600V4 */
#define _RI_TRACE_TIMER 1 /* RI600V4 uses CMT1 channel for the trace feature.*/
  ↓  修正  
#if (BSP_CFG_RTOS_USED == 4) && (BSP_CFG_RENESAS_RTOS_USED == 0) /* RI600V4 */
#define _RI_TRACE_TIMER 0 /* RI600V4 uses CMT1 channel for the trace feature.*/

smc_gen\r_t4_driver_rx\src\t4_driver.c  
#include "r_tsip_rx_if.h"  
  ↓  修正  
//#include "r_tsip_rx_if.h"  
```
 
 

# 6.e² studioプロジェクトリンクライブラリー設定  
  本設定は前述[1.X]で生成したライブラリーについて以下の設定を行います  
 6-1.プロジェクト・エクスプローラーの作成したプロジェクトをクリック後[Alt＋Enter]キーを押下  
 6-2.設定ダイアログボックス表示後、[ツール設定]タブ[linker]]設定の[Archives]を選択  
 6-3.ダイアログボックス[User defined archive(library) files(-I)]をボックス右上[+]を押下  
 6-4.[wolflib][asp]を設定(T4_Library_ether_ccrx_rxv1_littleが入っいる場合は選択後[×]を押下で削除)  
 (例:"C:\Users\etc\wolfssl-5.0.0-stable")  
 6-5.ダイアログ最下部[User defined archive search directories (-L))]のボックス右上[+]を押下し    Toppersライブラリー[asp]の場所、wolfライブラリー[wolflib]の場所を設定します   
 6-6.設定ダイアログボックス表示後、[ツール設定]タブ[linker]]設定の[Source]を選択   
 6-7.ダイアログボックス[Additional Input files]をボックス右上[+]を押下   
 6-8.ワークスペース[smc_gen/r_t4_rx/lib/gcc/libT4_Library_ether_gcc_rxv1_little.a]を選択し[適用して閉じる]を押下    

# 7.e² studioビルド  
 7-1.プロジェクト・エクスプローラーの作成したプロジェクトをクリック後プルダウンメニューから[プロジェクトのビルド(B)]キーを選択しビルドを行う(ビルドは必ず事前に[7-17]を実施します)  
 7-2.ビルドで生成されたELFファイルを[メニュー]→[実行(R)]→[実行(R)]又は[デバッグ(D)]でボードへ転送を行い、実行します  
 7-3.[WolfSSLDemo.c]のdefine値[#define SSL_SERVER]を定義を行うとサーバとしての動作になり、削除でクライアントとしての動作となる(通信相手はwolfsslサンプルにてlinux,windows,macにて作成の事)  
 7-4.バーチャルコンソールにて実行を確認します  


# 補足:新規にプロジェクトを作成する場合は以下を参照ください
# 補足1.e² studioプロジェクト作成 
 補足1-1.メニューの[ファイル]→[Renesas C/C++ Project]→[Renesas RX]を選択  
 補足1-2.プロジェクト選択BOXの[GCC for Renesas RX Executable Projec]を選択[次へ(N)]を選択  
 補足1-3.プロジェクト名を入力  
 補足1-4.[toolchain Seetings]で[C](デフォルト),ツールチェーン：[GCC for Renesas RX ](デフォルト)  
     ツールチェーン・バージョン：[8.3.0.202202]を選択   
 補足1-5.[Device Seetings]でTarget Board:[RX72NEnvisionKit]をプルダウンメニューから選択  
 補足1-6.[次へ(N)]を選択後次画面で[終了]を選択(use Smart Configuratorはチェック)  

 # 補足2.e² studioプロジェクト設定  
 補足2-1.プロジェクト名.scfgをダブルクリック  
 補足2-2.「概説」が表示されている領域の[コンポーネント]を選択  
 補足2-3.コンポーネントの[+]マークの[コンポーネントの追加]選択  
 補足2-4.[機能]プルダウンメニューから[通信]を選択  
 補足2-5.[Ethernet Driver][TCP/IP protocol stack]の[r_t4_driver_rx][r_t4_rx]の三つを選択後[終了]を選択  
 補足2-6.[r_bsp]をクリックし[プロパティ]ダイアログの 以下を変更します
```  
  User stack setting   2stacks
  User stack size      0x400
  Interrupt stack size 0x8000
  Heap size            0xA000 　　 
 ```
 補足2-7.[r_ether_rx]をクリックし[プロパティ]ダイアログの 以下を変更します
```  
  PHY-LSI address setting for ETHER0　　　　　　　1
  The register bus of PHY0 for  ETHER0/ETHER1    Use ETHER0　 
 ```
