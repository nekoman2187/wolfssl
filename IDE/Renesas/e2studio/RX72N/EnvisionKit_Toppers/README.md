## Renesas RX72N EnvisionKit with TOPPERS OS 

本デモはルネサス「RX72N EnvisionKit 」に「Toopers OS」を適用し「WolfSSL」の動作を確認するものである 

# 本デモについては以下が必要である 

1.Renesas e² studio Version: 2022-07 (22.7.0)以降   
2.Toopers OS 1.91.1 Renesas RX72N適用バージョン   
3.WolfSSL Release 5..0 以降 (gitレポジトリーより入手)  

# 以下に環境構築手順を示す 
# 1.e² studioプロジェクト作成 
 1-1.メニューの[ファイル]→[Renesas C/C++ Project]→[Renesas RX]を選択  
 1-2.プロジェクト選択BOXの[GCC for Renesas RX Executable Projec]を選択[次へ(N)]を選択  
 1-3.プロジェクト名を入力  
 1-4.[toolchain Seetings]で[C](デフォルト),ツールチェーン：[GCC for Renesas RX ](デフォルト)  
     ツールチェーン・バージョン：[8.3.0.202202]を選択   
 1-5.[Device Seetings]でTarget Board:[RX72NEnvisionKit]をプルダウンメニューから選択  
 1-6.[次へ(N)]を選択後次画面で[終了]を選択(use Smart Configuratorはチェック)  

 # 2.e² studioプロジェクト設定  
 2-1.プロジェクト名.scfgをダブルクリック  
 2-2.「概説」が表示されている領域の[コンポーネント]を選択  
 2-3.コンポーネントの[+]マークの[コンポーネントの追加]選択  
 2-4.[機能]プルダウンメニューから[通信]を選択  
 2-5.[Ethernet Driver][TCP/IP protocol stack]の[r_t4_driver_rx][r_t4_rx]の三つを選択後[終了]を選択  
 2-6.[r_bsp]をクリックし[プロパティ]ダイアログの 以下を変更する
```  
  User stack setting   2stacks
  User stack size      0x400
  Interrupt stack size 0x8000
  Heap size            0xA000 　　 
 ```
 2-7.[r_ether_rx]をクリックし[プロパティ]ダイアログの 以下を変更する
```  
  PHY-LSI address setting for ETHER0　　　　　　　1
  The register bus of PHY0 for  ETHER0/ETHER1    Use ETHER0　 
 ```


 # 3.ソースコード追加  
 3-1.git レポジトリwolfssl/IDE/Renesas/e2studio/RX72N/EnvisionKit_Toppersの[WolfSSLDemo]を作成したプロジェクト/src/へコピー(自動で作成された[プロジェクト名.c]を削除)    
      
 # 4.e² studioプロジェクトインクルードパス設定  
 4-1.プロジェクト・エクスプローラーの作成したプロジェクトをクリック後[Alt＋Enter]キーを押下  
 4-2.設定ダイアログボックス表示後、[ツール設定]タブ[Compiler]設定の[Include]を選択  
 4-3.ダイアログボックス右上[+]を押下しディレクトリを選択[3-1]で設定した[WolfSSLDemo]をワークスペースより設定  
 4-4.上記同様ワークスペース又はファイルシステムより[wolfssl-x.x.x]を設定  
     (例:"C:\Users\etc\wolfssl-5.0.0-stable")  
 4-4.上記[4-2]でダイアログ[Macro Defines(-D)]のボックス右上[+]を押下し[WOLFSSL_USER_SETTINGS]を設定  

  # 5.e² studioプロジェクトリンクライブラリー設定  
  (本設定は[7.ライブラリー作成]完了後行う)  
 5-1.プロジェクト・エクスプローラーの作成したプロジェクトをクリック後[Alt＋Enter]キーを押下  
 5-2.設定ダイアログボックス表示後、[ツール設定]タブ[linker]]設定の[Archives]を選択  
 5-3.ダイアログボックス[User defined archive(library) files(-I)]をボックス右上[+]を押下  
 5-4.[wolflib][asp]を設定(T4_Library_ether_ccrx_rxv1_littleが入っいる場合は選択後[×]を押下で削除)  
     (例:"C:\Users\etc\wolfssl-5.0.0-stable")  
 5-5.ダイアログ最下部[User defined archive search directories (-L))]のボックス右上[+]を押下し       
     Toppersライブラリー[asp]の場所、wolfライブラリー[wolflib]の場所を設定する   
 5-6.設定ダイアログボックス表示後、[ツール設定]タブ[linker]]設定の[Source]を選択   
 5-7.ダイアログボックス[Additional Input files]をボックス右上[+]を押下  
 5-8.ワークスペース[smc_gen/r_t4_rx/lib/gcc/libT4_Library_ether_gcc_rxv1_XXX.a](xxx  
     はインディアン形式による)を選択し[適用して閉じる]を押下  

  # 6.e² studio BSP修正
 6-1.本プロジェクトをToppersに適用する為、BSPに以下に変更及び修正を加える  
 ```  
smc_gen\general\r_cg_hardware_setup.c  
void R_Systeminit(void)  
    R_Interrupt_Create();  が存在した場合
	↓  修正  
   // R_Interrupt_Create();  
smc_gen\r_config
#define BSP_CFG_RTOS_USED               (0)
	↓  修正  
#define BSP_CFG_RTOS_USED               (4)

smc_gen\r_bsp\mcu\all\resetprg.c  
#include    "ri_cmt.h"    /*  Generated by cfg600 */
	↓  修正  
//#include    "ri_cmt.h"    /*  Generated by cfg600 */

#if (BSP_CFG_RTOS_USED == 0) || (BSP_CFG_RTOS_USED == 5)     /* Non-OS or Azure RTOS */
extern void R_BSP_MAIN_FUNCTION(void);
#endif
↓  修正  
#if (BSP_CFG_RTOS_USED == 0) || (BSP_CFG_RTOS_USED == 5) || (BSP_CFG_RTOS_USED == 4)    /* Non-OS or Azure RTOS */
extern void R_BSP_MAIN_FUNCTION(void);
#endif

R_BSP_POR_FUNCTION(R_BSP_STARTUP_FUNCTION)  
#if BSP_CFG_USER_STACK_ENABLE == 1
    INTERNAL_NOT_USED(ustack_area);
#endif
    INTERNAL_NOT_USED(istack_area);
#endif
	↓  修正  
#if BSP_CFG_USER_STACK_ENABLE == 1
   // INTERNAL_NOT_USED(ustack_area);
#endif
  //  INTERNAL_NOT_USED(istack_area);
#endif    
R_BSP_SET_INTB(R_BSP_SECTOP_INTVECTTBL);  
	↓  修正  
// R_BSP_SET_INTB(R_BSP_SECTOP_INTVECTTBL);  

#if BSP_CFG_RTOS_USED == 4  /* Renesas RI600V4 & RI600PX **/  
    R_BSP_MAIN_FUNCTION();★挿入  
    /** Does not change the MCU's user mode to user in Renesas RTOS. **/  
#else /** BSP_CFG_RTOS_USED != 4 **/  
#if BSP_CFG_RUN_IN_USER_MODE == 1  
    /** Change the MCU's user mode from supervisor to user **/  
    #if BSP_CFG_USER_STACK_ENABLE == 1  
        R_BSP_CHG_PMUSR();  
    #else  
        #error "Settings of BSP_CFG_RUN_IN_USER_MODE and BSP_CFG_USER_STACK_ENABLE are inconsistent with each other."  
    #endif  
#endif /** BSP_CFG_RUN_IN_USER_MODE **/  

#elif BSP_CFG_RTOS_USED == 4    /* Renesas RI600V4 & RI600PX */
#if BSP_CFG_RENESAS_RTOS_USED == RENESAS_RI600V4
 	↓  修正
#elif BSP_CFG_RTOS_USED == 6    /* Renesas RI600V4 & RI600PX */
#if BSP_CFG_RENESAS_RTOS_USED == RENESAS_RI600V4
   bsp_interrupt_open();

#include "kernel_ram.h"     /* generated by cfg600 */
#include "kernel_rom.h"     /* generated by cfg600 */
	↓  修正  
//#include "kernel_ram.h"     /* generated by cfg600 */
//#include "kernel_rom.h"     /* generated by cfg600 */

smc_gen\r_config\r_cmt_rx_config.h  (初回ビルド後に出力)
#if (BSP_CFG_RTOS_USED == 4) && (BSP_CFG_RENESAS_RTOS_USED == 0) /* RI600V4 */
#define _RI_TRACE_TIMER 1 /* RI600V4 uses CMT1 channel for the trace feature.*/
  ↓  修正  
#if (BSP_CFG_RTOS_USED == 4) && (BSP_CFG_RENESAS_RTOS_USED == 0) /* RI600V4 */
#define _RI_TRACE_TIMER 0 /* RI600V4 uses CMT1 channel for the trace feature.*/

smc_gen\r_t4_driver_rx\src\t4_driver.c  
#include "r_tsip_rx_if.h"  
  ↓  修正  
//#include "r_tsip_rx_if.h"  
```
  # 7.ライブラリー作成
  本デモに必要なToppersライブラリー、wolfSSLライブラリーを作成する  
 7-1.メニューの[ファイル]→[新規]→[Renesas C/C++ Project]→[Renesas RX]を選択  
 7-2.プロジェクト選択BOXの[GCC for Renesas Library Projec]を選択[次へ(N)]を選択  
 7-3.プロジェクト名を入力  
 7-4.[toolchain Seetings]で[C](デフォルト),ツールチェーン：[GCC for Renesas RX ](デフォルト)  
     ツールチェーン・バージョン：[8.3.0.202202]を選択   
 7-5.[Device Seetings]でTarget Board:[RX72NEnvisionKit]をプルダウンメニューから選択  
 7-6.[次へ(N)]を選択後次画面で[終了]を選択([Warn if stack size exceeds the limit, in byte]に24,576を設定)  
 7-7.作成したプロジェクトのsrc/に入手したWolfSSL Releaseの[wolfssl-x.x.x/src]をドラッグ  
     ダイアログ[ファイルおよびフォルダーの操作]で[ファイル及びフォルダーにリンク(L)]を選択し[OK]
     (プロジェクト作成時に自動生成されたsamplex.cは削除する)  
 7-8.設定ダイアログボックス表示後、[ツール設定]タブ[Compiler]設定の[Include]を選択  
 7-9.ダイアログボックス右上[+]を押下しディレクトリを選択[3-1]で設定した[wolfssl-x.x.x]をワークスペース又はファイルシステムより設定  
 7-10.ダイアログボックス右上[+]を押下しディレクトリをワークスペース[src]に設定  
 7-10. 上記[4-3.]の[WolfSSLDemo]内にある[user_settings.h]をワークスペース[src]にコピーする

 7-11. src\wolfcrypt\の以下ファイル
 ```  
aes_asm.asm
aes_asm.S
aes_gcm_asm.S
chacha_asm.S
fe_x25519_asm.S
poly1305_asm.S
sha256_asm.S
sha512_asm.S
sp_x86_64_asm.asm
sp_x86_64_asm.S
```  
をプロジェクト・エクスプローラーで選択しクリック後[Alt＋Enter]キーを押下    
[設定]ダイアログの[ビルドからリソースを除外]にチェックを入れる  

7-12.プロジェクト・エクスプローラーの作成したプロジェクトをクリック後プルダウンメニューから[プロジェクトのビルド(B)]キーを選択しビルドを行う  
 7-13. [アーカイブ]に[lib+プロジェクト名.a]が生成される（上記[5.5]で設定するのはプロジェクト名となる)  

7-14.Toppersライブラリーのビルドの為、XXXよりbuild_rx7n_toppers.zipをダウンロードし解凍する
(解凍先は以下で作成するプロジェクトと同じ階層とする)
7-15.メニューの[ファイル]→[新規]→[Makefile Project with Existing Code]を選択  
7-16.[既存のコードをインポート]ダイアログで[プロジェクト名]を入力し[既存のコードの場所]で[7-14]で解凍したディレクトリで[toppers/toppers_app]を指定し、[インデクサー設定に対するtoolchain]は[GCC for Renesas RX]を選択し[終了]を押下
7-17.以下のコマンドを実行
 ```  
$ pwd
プロジェクトと同じディレクトリ/toppeers_app
$ perl ./toppers_rx/asp/configure -T rx72n_gcc
$ make depend
```  
(コマンド実行ではMsys又は,Cygwinが必要)  
7-18.プロジェクト・エクスプローラーの作成したプロジェクトをクリック後プルダウンメニューから[プロジェクトのビルド(B)]キーを選択しビルドを行う(ビルドは必ず事前に[7-17]を実施する)  
7-19. [アーカイブ]に[libasp.a]が生成される（上記[5.5]で設定するのはプロジェクト名となる)  
7-20.ここまでで、ライブラリーの準備ができたため[1-6]で作成したプロジェクトをビルド
7-21.ビルドで生成されたELFファイル[メニュー]→[実行(R)]→[実行(R)]又は[デバッグ(D)]を行いボードで実行する
7-22.[3-1]のソース[WolfSSLDemo.c]のdefine値[#define SSL_SERVER]を定義するとサーバとしての動作になり、削除でクライアントとしての動作となる(通信相手はwolfsslサンプルにてlinux,windows,macにて作成の事)
7-22.バーチャルコンソールにて実行を確認する
